# Realtime Game Lobby Notes

This project uses PartyKit for realtime state and Next.js (App Router) for the UI. The code paths below match the current implementation.

## Key Files
- `party/index.ts` – PartyKit server handling lobby + game rooms.
- `party/constants.ts` – shared PartyKit constants (e.g. `SINGLETON_ROOM_ID`, `DEFAULT_MAX_ROUNDS`).
- `types/game.ts` – shared data model used by both server and client.
- `app/page.tsx` – server-rendered lobby fetch.
- `app/RoomList.tsx` – client lobby UI wired to PartySocket.
- `app/room/[id]/page.tsx` + `RoomClient.tsx` – room UI and socket handlers.

## Data Model (types/game.ts)
- `Game` tracks players, rounds, status (`predicting` → `playing` → `confirming` → `completed`), `currentRound`, `currentTricks`, `tricksPerRound`, and `roundConfirmations`.
- `Player` includes `predictedTricks` / `actualTricks` for in-progress rounds.
- `Round` stores per-player predictions, actuals, scores, and completion flag.
- `generateTricksArray(maxRounds)` returns the ascending/middle/descending trick counts; `DEFAULT_MAX_ROUNDS` is 7.

## PartyKit Server (party/index.ts)
- Lobby (`room.id === SINGLETON_ROOM_ID`)
  - `GET /party/lobby` → `{ rooms }` (pulled from PartyKit storage + in-memory `games` map).
  - `POST /party/lobby` with `{ name }` → creates a new `Game`, seeds the dedicated room’s storage, updates lobby listeners.
  - `onConnect` broadcasts the current lobby list so new sockets hydrate immediately.
- Game rooms
  - `onRequest` returns `{ game }` for SSR hydration.
  - Message types handled:
    - `joinGame` / `leaveGame`
    - `startGame` (requires ≥2 players)
    - `updatePrediction` → stores prediction and updates `predictedTricksSum`
    - `confirmPrediction` → flips status to `playing` once everyone has a prediction
    - `submitTricks` → calculates round scores when all players submit
    - `confirmRound` → advances to next round or marks game `completed` after all confirm
    - `editRound` → reopens a round, trims future rounds, and preloads predictions/actuals for fixes
  - State is persisted to both the room storage and lobby storage, then broadcast to the room (`gameState`) and lobby (`roomsUpdate`).
  - Server uses `hibernate: true` (`Party.ServerOptions`) so rooms can hibernate when idle (per PartyKit docs).

### PartySocket Usage (per latest PartyKit docs)
The client uses the React hook from `partysocket/react`, which mirrors the current PartyKit API:
```ts
import { usePartySocket } from "partysocket/react";

const socket = usePartySocket({
    host: PARTYKIT_HOST, // e.g. 127.0.0.1:1999 in dev
    party: "main",
    room: roomId,
    // PartyKit will add the client id (`_pk`) automatically to the request
    onOpen() { /* send join payload */ },
    onMessage(event) { /* handle gameState/error */ },
});
```
The same options apply as the upstream API: `host`, `room`, optional `party`, and optional `query` (object or async) if you need to attach params.

## Client Flow
- Lobby:
  - Server action `createRoom` posts to `/party/lobby` then redirects to the new room with `player` query param.
  - `RoomList` subscribes to `roomsUpdate` and shows live player counts; it no longer depends on client-side writes to the PartyKit server beyond join navigation.
- Room:
  - SSR fetch hydrates the current `game`.
  - `RoomClient` joins via `joinGame`, then reacts to `gameState` broadcasts for predictions, trick submissions, confirmations, and round edits.
  - Local UI keeps `predictedTricks`/`actualTricks` in sync with the latest server payloads so reconnections are resilient.

## Environment & Routing
- `.env.local`: `NEXT_PUBLIC_PARTYKIT_HOST` (defaults to `127.0.0.1:1999`) and optional `NEXT_PUBLIC_PARTYKIT_PROTOCOL` (`http`/`https`).
- `next.config.ts` proxies `/party/*` and `/parties/:party/*` to the configured PartyKit origin for local dev.

## Dev Loop
1) `pnpm dev` (Next.js on `http://localhost:3003`).
2) `pnpm exec partykit dev` (PartyKit on `127.0.0.1:1999`).
3) Open the lobby, create a game, share the room URL (includes `?player=`).

If the lobby looks stale, ensure the PartyKit server is running and that the client is pointed at the same `PARTYKIT_HOST`.
